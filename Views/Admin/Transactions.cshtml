@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Transactions";
}

<div class="row mb-4">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-person"></i></span>
            <input type="number" class="form-control" id="filterPlayerId" placeholder="Player ID (leave empty for all)" min="1">
            <button class="btn btn-primary" onclick="loadTransactions()">
                <i class="bi bi-search"></i> Search
            </button>
            <button class="btn btn-outline-secondary" onclick="loadAllTransactions()">
                <i class="bi bi-list"></i> All
            </button>
        </div>
    </div>
    <div class="col-md-6 text-end">
        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
            <i class="bi bi-plus-lg"></i> New Transaction
        </button>
        <span class="badge bg-primary fs-6" id="transactionCount">0 transactions</span>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-receipt me-2"></i>Transaction History
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Player</th>
                                <th>Item</th>
                                <th>Type</th>
                                <th>Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTable">
                            <tr><td colspan="6" class="text-center py-4">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Player Quick Select -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-people me-2"></i>Quick Select Player
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="playersList">
                    <div class="list-group-item text-center py-3">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Transaction Types -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-pie-chart me-2"></i>By Type
            </div>
            <div class="card-body">
                <canvas id="typeChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-plus-lg me-2"></i>New Transaction</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Player <span class="text-danger">*</span></label>
                    <select class="form-select" id="transactionPlayerId" required>
                        <option value="">Select player...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Item</label>
                    <select class="form-select" id="transactionItemId">
                        <option value="">Select item (optional)...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Type <span class="text-danger">*</span></label>
                    <select class="form-select" id="transactionKind" required>
                        <option value="Item">Item</option>
                        <option value="Vehicle">Vehicle</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createTransaction()">
                    <i class="bi bi-check-lg"></i> Create
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const API_BASE = '';
    let allTransactions = [];

    async function loadPlayers() {
        try {
            const data = await fetch(`${API_BASE}/api/gameapi/players`).then(r => r.json());
            const div = document.getElementById('playersList');
            const select = document.getElementById('transactionPlayerId');
            
            let html = '';
            let options = '<option value="">Select player...</option>';
            
            data.forEach(p => {
                html += `
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="selectPlayer(${p.id}); return false;">
                        <div>
                            <strong>${p.name}</strong>
                            <small class="text-muted d-block">${p.mode}</small>
                        </div>
                        <span class="badge bg-warning">${p.experience} XP</span>
                    </a>
                `;
                options += `<option value="${p.id}">${p.name} (${p.mode})</option>`;
            });
            
            div.innerHTML = html || '<div class="list-group-item">No players</div>';
            select.innerHTML = options;
        } catch (err) {
            console.error(err);
        }
    }

    async function loadItems() {
        try {
            const data = await fetch(`${API_BASE}/api/gameapi/items`).then(r => r.json());
            const select = document.getElementById('transactionItemId');
            
            let options = '<option value="">Select item (optional)...</option>';
            data.forEach(i => {
                options += `<option value="${i.id}">${i.name} (${i.category} - ${i.xpCost} XP)</option>`;
            });
            select.innerHTML = options;
        } catch (err) {
            console.error(err);
        }
    }

    function selectPlayer(playerId) {
        document.getElementById('filterPlayerId').value = playerId;
        loadTransactions();
    }

    async function loadAllTransactions() {
        document.getElementById('filterPlayerId').value = '';
        try {
            const data = await fetch(`${API_BASE}/api/gameapi/transactions`).then(r => r.json());
            allTransactions = data;
            renderTransactions(data);
            updateChart(data);
            document.getElementById('transactionCount').textContent = `${data.length} transactions`;
        } catch (err) {
            console.error(err);
        }
    }

    async function loadTransactions() {
        const playerId = document.getElementById('filterPlayerId').value;
        
        if (!playerId) {
            loadAllTransactions();
            return;
        }

        try {
            const data = await fetch(`${API_BASE}/api/gameapi/players/${playerId}/transactions`).then(r => r.json());
            allTransactions = data;
            renderTransactions(data);
            updateChart(data);
            document.getElementById('transactionCount').textContent = `${data.length} transactions`;
        } catch (err) {
            document.getElementById('transactionsTable').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-danger">Player not found</td></tr>';
        }
    }

    function renderTransactions(transactions) {
        const tbody = document.getElementById('transactionsTable');
        
        if (!transactions || transactions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">No transactions found</td></tr>';
            return;
        }

        let html = '';
        transactions.forEach(t => {
            const date = new Date(t.occurredAt);
            const timeAgo = getTimeAgo(date);
            
            html += `
                <tr>
                    <td><strong>#${t.id}</strong></td>
                    <td>
                        <a href="#" class="player-link" data-id="${t.playerId}">
                            ${t.playerName || 'Player ' + t.playerId}
                        </a>
                    </td>
                    <td>${t.itemName || (t.itemId ? `Item #${t.itemId}` : '<span class="text-muted">N/A</span>')}</td>
                    <td>
                        <span class="badge ${t.kind === 'Vehicle' ? 'bg-warning' : 'bg-info'}">
                            <i class="bi ${t.kind === 'Vehicle' ? 'bi-car-front' : 'bi-box'}"></i>
                            ${t.kind}
                        </span>
                    </td>
                    <td>
                        <small class="text-muted" title="${date.toLocaleString()}">${timeAgo}</small>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${t.id}" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        tbody.innerHTML = html;
        
        // Attach event listeners
        tbody.querySelectorAll('.player-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                selectPlayer(link.dataset.id);
            });
        });
        tbody.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', () => deleteTransaction(btn.dataset.id));
        });
    }

    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        
        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
        if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
        return Math.floor(seconds / 86400) + ' days ago';
    }

    async function createTransaction() {
        const playerId = document.getElementById('transactionPlayerId').value;
        const itemId = document.getElementById('transactionItemId').value;
        const kind = document.getElementById('transactionKind').value;

        if (!playerId) {
            alert('Please select a player');
            return;
        }

        try {
            const resp = await fetch(`${API_BASE}/api/gameapi/transactions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    playerId: parseInt(playerId),
                    itemId: itemId ? parseInt(itemId) : null,
                    kind: kind
                })
            });

            if (resp.ok) {
                alert('Transaction created successfully!');
                bootstrap.Modal.getInstance(document.getElementById('addTransactionModal')).hide();
                loadAllTransactions();
            } else {
                const error = await resp.json();
                alert('Error: ' + (error.title || 'Failed to create transaction'));
            }
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }

    async function deleteTransaction(id) {
        if (!confirm('Are you sure you want to delete this transaction?')) return;

        try {
            const resp = await fetch(`${API_BASE}/api/gameapi/transactions/${id}`, {
                method: 'DELETE'
            });

            console.log('Delete response status:', resp.status);

            if (resp.status === 204 || resp.ok) {
                alert('Transaction deleted!');
                loadAllTransactions();
            } else {
                const errorText = await resp.text();
                alert('Failed to delete transaction: ' + (errorText || resp.status));
            }
        } catch (err) {
            console.error('Delete error:', err);
            alert('Error: ' + err.message);
        }
    }

    let typeChart = null;
    function updateChart(transactions) {
        const types = {};
        transactions.forEach(t => {
            types[t.kind] = (types[t.kind] || 0) + 1;
        });

        const ctx = document.getElementById('typeChart').getContext('2d');
        
        if (typeChart) typeChart.destroy();
        
        typeChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(types),
                datasets: [{
                    data: Object.values(types),
                    backgroundColor: ['#6366f1', '#f59e0b', '#10b981', '#ef4444']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    // Check URL params
    const urlParams = new URLSearchParams(window.location.search);
    const playerIdParam = urlParams.get('playerId');
    if (playerIdParam) {
        document.getElementById('filterPlayerId').value = playerIdParam;
        loadTransactions();
    } else {
        loadAllTransactions();
    }

    loadPlayers();
    loadItems();
</script>
}
