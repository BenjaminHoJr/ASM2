@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Transactions";
}

<div class="row mb-4">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-person"></i></span>
            <input type="number" class="form-control" id="filterPlayerId" placeholder="Player ID" min="1">
            <button class="btn btn-primary" onclick="loadTransactions()">
                <i class="bi bi-search"></i> Search
            </button>
            <button class="btn btn-outline-secondary" onclick="clearFilter()">
                <i class="bi bi-x-lg"></i> Clear
            </button>
        </div>
    </div>
    <div class="col-md-6 text-end">
        <span class="badge bg-primary fs-6" id="transactionCount">0 transactions</span>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-receipt me-2"></i>Transaction History
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Player</th>
                                <th>Item</th>
                                <th>Type</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTable">
                            <tr><td colspan="5" class="text-center py-4">Select a player to view transactions</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Player Quick Select -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-people me-2"></i>Quick Select Player
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="playersList">
                    <div class="list-group-item text-center py-3">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Transaction Types -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-pie-chart me-2"></i>By Type
            </div>
            <div class="card-body">
                <canvas id="typeChart"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const API_BASE = '';
    let allTransactions = [];

    async function loadPlayers() {
        try {
            const data = await fetch(`${API_BASE}/api/gameapi/players/purchase-counts`).then(r => r.json());
            const div = document.getElementById('playersList');
            
            let html = '';
            data.forEach(item => {
                const p = item.player;
                if (!p) return;
                html += `
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="selectPlayer(${p.id})">
                        <div>
                            <strong>${p.name}</strong>
                            <small class="text-muted d-block">${p.mode}</small>
                        </div>
                        <span class="badge bg-primary rounded-pill">${item.purchaseCount}</span>
                    </a>
                `;
            });
            div.innerHTML = html || '<div class="list-group-item">No players</div>';
        } catch (err) {
            console.error(err);
        }
    }

    function selectPlayer(playerId) {
        document.getElementById('filterPlayerId').value = playerId;
        loadTransactions();
    }

    async function loadTransactions() {
        const playerId = document.getElementById('filterPlayerId').value;
        
        if (!playerId) {
            document.getElementById('transactionsTable').innerHTML = '<tr><td colspan="5" class="text-center py-4">Please enter a Player ID</td></tr>';
            return;
        }

        try {
            const data = await fetch(`${API_BASE}/api/gameapi/players/${playerId}/transactions`).then(r => r.json());
            allTransactions = data;
            renderTransactions(data);
            updateChart(data);
            document.getElementById('transactionCount').textContent = `${data.length} transactions`;
        } catch (err) {
            document.getElementById('transactionsTable').innerHTML = '<tr><td colspan="5" class="text-center py-4 text-danger">Player not found</td></tr>';
        }
    }

    function renderTransactions(transactions) {
        const tbody = document.getElementById('transactionsTable');
        
        if (!transactions || transactions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No transactions found</td></tr>';
            return;
        }

        let html = '';
        transactions.forEach(t => {
            const date = new Date(t.occurredAt);
            const timeAgo = getTimeAgo(date);
            
            html += `
                <tr>
                    <td><strong>#${t.id}</strong></td>
                    <td>Player ${t.playerId}</td>
                    <td>${t.itemId ? `Item #${t.itemId}` : '<span class="text-muted">N/A</span>'}</td>
                    <td>
                        <span class="badge ${t.kind === 'Vehicle' ? 'bg-warning' : 'bg-info'}">
                            <i class="bi ${t.kind === 'Vehicle' ? 'bi-car-front' : 'bi-box'}"></i>
                            ${t.kind}
                        </span>
                    </td>
                    <td>
                        <small class="text-muted" title="${date.toLocaleString()}">${timeAgo}</small>
                    </td>
                </tr>
            `;
        });
        tbody.innerHTML = html;
    }

    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        
        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
        if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
        return Math.floor(seconds / 86400) + ' days ago';
    }

    let typeChart = null;
    function updateChart(transactions) {
        const types = {};
        transactions.forEach(t => {
            types[t.kind] = (types[t.kind] || 0) + 1;
        });

        const ctx = document.getElementById('typeChart').getContext('2d');
        
        if (typeChart) typeChart.destroy();
        
        typeChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(types),
                datasets: [{
                    data: Object.values(types),
                    backgroundColor: ['#6366f1', '#f59e0b', '#10b981', '#ef4444']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    function clearFilter() {
        document.getElementById('filterPlayerId').value = '';
        document.getElementById('transactionsTable').innerHTML = '<tr><td colspan="5" class="text-center py-4">Select a player to view transactions</td></tr>';
        document.getElementById('transactionCount').textContent = '0 transactions';
    }

    // Check URL params
    const urlParams = new URLSearchParams(window.location.search);
    const playerIdParam = urlParams.get('playerId');
    if (playerIdParam) {
        document.getElementById('filterPlayerId').value = playerIdParam;
        loadTransactions();
    }

    loadPlayers();
</script>
}
